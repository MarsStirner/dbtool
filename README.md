База данных ТМИС
================


Утилита dbtool
--------------

Утилита предназначена для апгрейдов и даунгрейдов версий схемы бд, таких как
создание новых таблиц, изменение существующих и т.д., и версий содержимого бд
(контента), такого как наполнение справочников rb, создание, обновление типов
действий и свойств и пр.


### Зависимости

* Python 2.6.6
* mysql-python

для ранних модулей обновлений дополнительно требуются
* Qt4 с qtmysql
* PyQt4

### Конфигурация

Файл `dbtool.conf` в каталоге с `dbtool` содержит настройки соединения к БД
и другие параметры, необходимые для работы утилиты:

    [database]
	host = example.com
	username = user1
	password = password1
	dbname = dbname
	definer = `root`@`localhost`
	
	[content]
	content_type = 
	
	[rlsConvert]
	rlsPath = 
	
	[misc]
	log_filename = 

Для работы в режиме обновления бд обязательно должны быть заполнены разделы
database, content и misc. rlsConvert используется только для конвертации
и импорта бд лекарственных средств.

Параметр content_type определяет тип бд, для которой будут выбираться модули
обновления содержимого бд. Поддерживаемые значения:
 * common - обновления для всех видов бд
 * fnkc - бд ФНКЦ (сюда же подойдет референсная бд)
 * pnz - бд Пензы


### Использование

Справка:

    $ dbtool -h
    использование: dbtool [ -u <version> | -l | -h ]

	аргументы:
	  -u, --update <version>   обновить схему базы данных до версии <version>
	  --update-content         обновить контент базы данных до версии <version>
	  -l, --list               вывести список модулей обновлений с указанной текущей версией бд
	  -c, --change-definers    изменить все определители (definer) у процедур, триггеров и представлений (views) на указанный в конфигурационном файле
	  -h, --help               показать это сообщение

Список обновлений базы с указанием текущего:

    $ dbtool -l
    Модули обновления схемы:
        0 БД без версионирования схемы
    * 	1 Системная таблица Meta для хранения версий схемы БД
    Модули обновления контента:
 	*   1 - Начальное состояние - запись в Meta версии content_version

Обновить схему бд на указанную версию:

    $ dbtool -u2
    В базе данных не найдена таблица `Meta`, предполагается, что версия бд равна 0
	Обновление версии схемы до 1...
	Системная таблица Meta для хранения версий схемы БД
	
	Схема бд обновлена до версии 1

Обновить контент бд на указанную версию:

После того как в конфигурационном файле был установлен параметр текущего
типа бд, можно приступить к обновлению:
 
    $ dbtool --update-content=1
	Обновление версии контента до 1...
	Начальное состояние - запись в Meta версии content_version
	
	Контент бд обновлен до версии 1


### Разработка новых модулей

Модули в директории /updates предназначены для обновления схемы бд.
Сюда относится весь DDL: CREATE TABLE, ALTER TABLE, DROP TABLE и пр.

Модули в директории /content_updates предназначены для обновления содержимого
бд. Сюда относится весь DML, например, наполнение таблиц-справочников rb,
создание и редактирование типов действий и свойств и пр.

Модули обновления контента предназначены для обновления определенных типов бд.
На данный момент поддерживаются бд ФНКЦ и Пензенской области. Также можно
создавать общие модули, которые будут подходить для всех видов бд.

Какой файл модуля будет выполняться при обновлении определяется по названию
файла. Файл имеет название вида 'content[version][type].py', где
version - номер версии, type - тип бд (может быть пустым для общих модулей).
Например,
content002pnz - обновление контента номер 2 для баз Пензы
content002fnkc - обновление контента номер 2 для базы ФНКЦ
content002 - обновление контента номер 2, которое будет выполняться для всех бд

При создании модуля обновления новой версии, специфичного для одного вида бд,
нужно создавать пустой общий модуль обновления для того, чтобы поддерживать
единую нумерацию версий обновления контента для всех видов бд.


